setup {

  module_load (
    <%= node['lighttpd2']['modules'].map { |m| '"mod_%s"' % m }.join(",\n    ") %>
  );
        lua.plugin "core.lua";
        openssl [
          "listen" => "0.0.0.0:443",
          "pemfile" => "<%= node['lighttpd2']['etc'] %>/server.pem"<% if File.exists?("%s/certs.pem" % node['lighttpd2']['etc']) -%>,
          "ca-file" => "<%= node['lighttpd2']['etc'] %>/certs.pem"
        <% end -%>
        ];

  log ["debug" => "", "*" => "stderr"];
  accesslog "stdout";
  accesslog.format "%h %V %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"";

  static.exclude_extensions ( ".php", ".pl", ".fcgi", "~", ".inc" );

}


include "/opt/lighttpd2/etc/mimetypes.conf";
docroot "/var/www";
index ("index.html", "index.htm");
<% if node['lighttpd2']['applications'].size > 0 %>

  <% node['lighttpd2']['applications'].each do |app| %>
    include <%= '"%s/%s.conf"' % [ node['lighttpd2']['conf_dir'], app[:name] ] %>;
  <% end %>

  if request.scheme == "https" { vhost.map [
  <% node['lighttpd2']['applications'].each do |app| %>
    <%= app[:hostnames].map { |host| '"%s" => %s' % [host, "#{app[:name]}_workload"] }.join(",\n    ") %>
  <% end %>
    ];
  }
<% end %>
static;
